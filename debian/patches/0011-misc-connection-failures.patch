From: Aron Xu <aron@debian.org>
Date: Mon, 13 Feb 2012 19:06:52 +0800
Subject: [PATCH] misc connection failures

---
 netcat.c |   21 ++++++++++++++++++---
 1 files changed, 18 insertions(+), 3 deletions(-)

--- a/netcat.c
+++ b/netcat.c
@@ -164,7 +164,7 @@
 	struct addrinfo hints;
 	struct servent *sv;
 	socklen_t len;
-	struct sockaddr_storage cliaddr;
+        struct sockaddr_storage cliaddr;
 	char *proxy = NULL;
 	const char *errstr, *proxyhost = "", *proxyport = NULL;
 	struct addrinfo proxyhints;
@@ -503,6 +503,8 @@
 
 			if (!kflag)
 				break;
+                        if (vflag)
+                                fprintf(stderr, "Connection closed, listening again.\n");
 		}
 	} else if (family == AF_UNIX) {
 		ret = 0;
@@ -599,6 +601,8 @@
 		return (-1);
 	}
 
+        unlink(path);
+
 	if (bind(s, (struct sockaddr *)&sun, SUN_LEN(&sun)) < 0) {
 		close(s);
 		return (-1);
@@ -620,8 +624,10 @@
 		if ((s = unix_bind(unix_dg_tmp_socket)) < 0)
 			return (-1);
 	} else {
-		if ((s = socket(AF_UNIX, SOCK_STREAM, 0)) < 0)
+		if ((s = socket(AF_UNIX, SOCK_STREAM, 0)) < 0) {
+                        errx(1,"create unix socket failed");
 			return (-1);
+                }
 	}
 	(void)fcntl(s, F_SETFD, 1);
 
@@ -632,9 +638,11 @@
 	    sizeof(sun.sun_path)) {
 		close(s);
 		errno = ENAMETOOLONG;
+                warn("unix connect abandoned");
 		return (-1);
 	}
 	if (connect(s, (struct sockaddr *)&sun, SUN_LEN(&sun)) < 0) {
+                warn("unix connect failed");
 		close(s);
 		return (-1);
 	}
